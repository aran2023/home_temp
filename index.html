<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì•„ë€ì˜ ìŠ¤ë§ˆíŠ¸ íŒœ ê´€ì œì„¼í„°</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        body { background-color: #f4f6f9; font-family: 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; }
        .container { max-width: 600px; padding-top: 20px; }
        .card { 
            border-radius: 16px; 
            border: none; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
            background: white; 
            overflow: hidden;
        }

        /* 1. í—¤ë” ìŠ¤íƒ€ì¼ */
        .header-title { font-size: 1.3rem; font-weight: 800; color: #333; display: flex; align-items: center; gap: 8px; }
        .status-badge { 
            font-size: 0.85rem; padding: 6px 12px; border-radius: 20px; 
            display: inline-flex; align-items: center; gap: 6px; font-weight: 600;
            transition: all 0.3s;
        }
        .status-online { background-color: #ffeaea; color: #d63384; } /* ì—°ê²° í™•ì¸ ì¤‘ ìƒ‰ìƒ */
        .status-active { background-color: #d1e7dd; color: #0f5132; } /* ì—°ê²°ë¨ */
        .dot { height: 8px; width: 8px; background-color: #d63384; border-radius: 50%; display: inline-block; }
        .dot.active { background-color: #198754; animation: blink 1.5s infinite; }

        /* 2. í˜„ì¬ ì˜¨ë„ */
        .temp-display { font-size: 3.5rem; font-weight: 800; color: #333; text-align: center; }
        .temp-unit { font-size: 1.5rem; color: #888; font-weight: normal; }

        /* í…Œì´ë¸” */
        .table-custom th { background-color: #f8f9fa; font-size: 0.9rem; color: #666; }
        .table-custom td { font-size: 0.95rem; vertical-align: middle; }

        @keyframes blink { 0% {opacity: 1;} 50% {opacity: 0.4;} 100% {opacity: 1;} }
    </style>
</head>
<body>

<div class="container">
    
    <div class="d-flex justify-content-between align-items-center mb-4 px-2">
        <div class="header-title">
            <span>ğŸ  ìš°ë¦¬ì§‘ ê´€ì œì„¼í„°</span>
        </div>
        <div id="connectionStatus" class="status-badge status-online">
            <span class="dot" id="statusDot"></span>
            <span id="statusText">ì—°ê²° í™•ì¸ ì¤‘...</span>
        </div>
    </div>

    <div class="card p-4 text-center">
        <h6 class="text-secondary fw-bold mb-0">í˜„ì¬ ì˜¨ë„ (Realtime)</h6>
        <div class="temp-display" id="currentTemp">--.-<span class="temp-unit">Â°C</span></div>
    </div>

    <div class="card p-3">
        <h6 class="fw-bold text-secondary mb-3">ğŸ“‰ 14ì¼ê°„ ì˜¨ë„ ë³€í™” (ìµœì €/ìµœê³ )</h6>
        <div style="height: 300px;"> <canvas id="dailyChart"></canvas>
        </div>
    </div>

    <div class="card p-3">
        <h6 class="fw-bold text-secondary mb-3">ğŸ“‹ ìƒì„¸ ê¸°ë¡ (ìµœì‹ ìˆœ)</h6>
        <div style="max-height: 350px; overflow-y: auto;">
            <table class="table table-custom table-hover text-center">
                <thead>
                    <tr>
                        <th width="60%">ì¼ì‹œ (YY-MM-DD HH:MM)</th>
                        <th width="40%">ì˜¨ë„</th>
                    </tr>
                </thead>
                <tbody id="tempTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ===========================================================
    // â˜…â˜…â˜… ì•„ë€ë‹˜ì˜ API KEYë¥¼ ì—¬ê¸°ì— ë„£ì–´ì£¼ì„¸ìš” â˜…â˜…â˜…
    // ===========================================================
    const firebaseConfig = {
        apiKey: "AIzaSyBJyb4wnubcJq2hVTnyyAgsO6FaikCW30M", 
        databaseURL: "https://temp-db-c4471-default-rtdb.firebaseio.com/"
    };
    // ===========================================================

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 1. ìƒíƒœ ëª¨ë‹ˆí„°ë§ ë¡œì§ (Heartbeat)
    const statusBox = document.getElementById('connectionStatus');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    let lastSignalTime = 0;

    // 1ì´ˆë§ˆë‹¤ ì—°ê²° ìƒíƒœ ì²´í¬
    setInterval(() => {
        const now = Date.now();
        // 60ì´ˆ ì´ìƒ ë°ì´í„° ì—†ìœ¼ë©´ ì—°ê²° ëŠê¹€ ê°„ì£¼
        if (lastSignalTime > 0 && (now - lastSignalTime < 60000)) {
            statusBox.className = "status-badge status-active";
            statusDot.className = "dot active";
            statusText.innerText = "ì™€ì´íŒŒì´ ì—°ê²°ë¨";
        } else {
            statusBox.className = "status-badge status-online"; // ì›ë˜ ìƒ‰(ë¶‰ì€ë¼)
            statusDot.className = "dot";
            statusText.innerText = "ì—°ê²° í™•ì¸ ì¤‘...";
        }
    }, 1000);


    // 2. í˜„ì¬ ì˜¨ë„ ì‹¤ì‹œê°„ í‘œì‹œ
    const currentTempDiv = document.getElementById('currentTemp');
    db.ref('CurrentTemp').on('value', (snapshot) => {
        const temp = snapshot.val();
        if(temp) {
            currentTempDiv.innerHTML = `${parseFloat(temp).toFixed(1)}<span class="temp-unit">Â°C</span>`;
            // ë°ì´í„° ìˆ˜ì‹  ì‹œê·¸ë„ ê°±ì‹ 
            lastSignalTime = Date.now();
        }
    });

    // 3. ì°¨íŠ¸ ì´ˆê¸°í™” (14ì¼ ê³ ì •í˜•)
    const ctx = document.getElementById('dailyChart').getContext('2d');
    
    // 14ì¼ì¹˜ ë‚ ì§œ ë¼ë²¨ ìƒì„± (ì˜¤ëŠ˜ ê¸°ì¤€ ê³¼ê±° 14ì¼)
    const dayLabels = [];
    const limit0 = [];  // 0ë„ ì„ 
    const limit35 = []; // 35ë„ ì„ 
    
    for(let i=13; i>=0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        // í•˜ë£¨ì— 2ì¹¸ì”© (ìµœì €, ìµœê³ )
        dayLabels.push(`${mm}/${dd}(ìµœì €)`, `${mm}/${dd}(ìµœê³ )`);
        limit0.push(0, 0);   // ê¸°ì¤€ì„  ë°ì´í„° ì±„ìš°ê¸°
        limit35.push(35, 35);
    }

    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dayLabels,
            datasets: [
                {
                    label: 'ì˜¨ë„',
                    data: new Array(28).fill(null), // ì´ˆê¸°ê°’ ë¹„ì›€
                    borderColor: '#36a2eb',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 3
                },
                {
                    label: 'ëƒ‰í•´ ìœ„í—˜ì„  (0ë„)',
                    data: limit0,
                    borderColor: 'red',
                    borderWidth: 1,
                    pointRadius: 0,
                    borderDash: [5, 5], // ì ì„ 
                    fill: false
                },
                {
                    label: 'ê³ ì˜¨ ê²½ê³ ì„  (35ë„)',
                    data: limit35,
                    borderColor: 'blue',
                    borderWidth: 1,
                    pointRadius: 0,
                    borderDash: [5, 5],
                    fill: false
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: { 
                    ticks: { 
                        font: { size: 10 },
                        callback: function(val, index) {
                            // ë¼ë²¨ì´ ë„ˆë¬´ ë§ìœ¼ë¯€ë¡œ ë‚ ì§œ(ìµœê³ )ì¼ ë•Œë§Œ ê¸€ì í‘œì‹œ
                            const label = this.getLabelForValue(val);
                            return label.includes("ìµœê³ ") ? label.split('(')[0] : '';
                        }
                    },
                    grid: { display: false } 
                },
                y: { 
                    min: -10, max: 40,
                    grid: { color: '#eee' }
                }
            },
            plugins: { legend: { display: false } }
        }
    });


    // 4. ë°ì´í„° ë¡œë“œ ë° ë¶„ì„ (ìƒì„¸í‘œ + ê·¸ë˜í”„ ê³„ì‚°)
    const tableBody = document.getElementById('tempTableBody');

    // ìµœì‹  ë°ì´í„° 3000ê°œ ì •ë„ ê°€ì ¸ì™€ì„œ 14ì¼ì¹˜ ë¶„ì„ (ë„‰ë„‰í•˜ê²Œ)
    db.ref('History').orderByKey().limitToFirst(3000).on('value', (snapshot) => {
        tableBody.innerHTML = ""; // í…Œì´ë¸” ì´ˆê¸°í™”
        
        const rawData = [];
        const dailyTemps = {}; // ë‚ ì§œë³„ ì˜¨ë„ ëª¨ìŒ { "260201": [22.1, 24.5...], ... }

        snapshot.forEach(child => {
            const key = child.key; // ì˜ˆ: 1229..._260201_1300
            const val = parseFloat(child.val());
            
            // í‚¤ íŒŒì‹±
            const parts = key.split('_');
            if(parts.length >= 3) {
                const dateCode = parts[1]; // 260201
                const timeCode = parts[2]; // 1300
                
                // (1) í…Œì´ë¸”ìš© ë°ì´í„° ìˆ˜ì§‘
                rawData.push({ date: dateCode, time: timeCode, temp: val });

                // (2) ì°¨íŠ¸ ë¶„ì„ìš© ë°ì´í„° ë¶„ë¥˜
                if(!dailyTemps[dateCode]) dailyTemps[dateCode] = [];
                dailyTemps[dateCode].push(val);
            }
        });

        // [í…Œì´ë¸” ë Œë”ë§] (ìµœì‹  50ê°œë§Œ í‘œì‹œ)
        rawData.slice(0, 50).forEach(item => {
            // YY-MM-DD HH:MM ë³€í™˜
            const y = item.date.substr(0,2);
            const m = item.date.substr(2,2);
            const d = item.date.substr(4,2);
            const h = item.time.substr(0,2);
            const min = item.time.substr(2,2);
            
            const displayDate = `${y}-${m}-${d} ${h}:${min}`;
            
            const row = `<tr>
                <td class="text-secondary">${displayDate}</td>
                <td class="fw-bold">${item.temp.toFixed(1)}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        // [ì°¨íŠ¸ ë°ì´í„° ê³„ì‚°]
        const chartDataPoints = [];
        
        // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ì¤€ 14ì¼ ë£¨í”„
        for(let i=13; i>=0; i--) {
            const d = new Date();
            d.setDate(d.getDate() - i);
            // ë‚ ì§œ ì½”ë“œë¡œ ë³€í™˜ (2026ë…„ ê°€ì • -> '26' + mm + dd)
            const yy = String(d.getFullYear()).substr(2,2);
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            const targetKey = yy + mm + dd; // "260201"

            if (dailyTemps[targetKey] && dailyTemps[targetKey].length > 0) {
                // ë°ì´í„°ê°€ ìˆëŠ” ë‚ ì´ë©´ ìµœì €, ìµœê³  ê³„ì‚°
                const minT = Math.min(...dailyTemps[targetKey]);
                const maxT = Math.max(...dailyTemps[targetKey]);
                chartDataPoints.push(minT, maxT); // 2ì¹¸ ì°¨ì§€
            } else {
                // ë°ì´í„° ì—†ìœ¼ë©´ null (ê·¸ë˜í”„ ëŠê¹€)
                chartDataPoints.push(null, null);
            }
        }

        // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        chart.data.datasets[0].data = chartDataPoints;
        chart.update();
    });

</script>

</body>
</html>